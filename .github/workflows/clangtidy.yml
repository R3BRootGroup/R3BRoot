name: static analysis
on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

  workflow_dispatch:

permissions: write-all

jobs:
  clang-tidy:
    runs-on: ubuntu-latest
    container: 
      image: yanzhaowang/cvmfs_clang:v15
      volumes:
        - /tmp:/cvmfs
      env:
        CVMDIR: /cvmfs/fairsoft.gsi.de
      options: --user root --privileged  --ulimit nofile=10000:10000 --cap-add SYS_ADMIN --device /dev/fuse
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: mount cvmfs
      run: |
        wget https://cernbox.cern.ch/remote.php/dav/public-files/RmnTeeOZpYjCJQb/masterkey.gsi.de.pub
        mv masterkey.gsi.de.pub /etc/cvmfs/keys
        cp .githubfiles/fairsoft.gsi.de.conf /etc/cvmfs/config.d
        mkdir -p ${CVMDIR}
        mount -t cvmfs fairsoft.gsi.de ${CVMDIR}

    - name: cmake configure
      run: |
        export SIMPATH=${CVMDIR}/debian10/fairsoft/nov22p1
        export FAIRROOTPATH=${CVMDIR}/debian10/fairroot/v18.8.0_fs_nov22p1
        export PATH=${SIMPATH}/bin:$PATH
        git config --global --add safe.directory $GITHUB_WORKSPACE
        git clone https://github.com/R3BRootGroup/macros.git
        cmake . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=on -DBUILD_GEOMETRY=OFF -DUSE_DIFFERENT_COMPILER=TRUE

    - name: clang-tidy check
      run: |
        mkdir -p clang-tidy-result
        git diff -U0 HEAD^ | python3 $PWD/util/clang-tidy-diff.py -p1 -path build -j4 -use-color \
        -iregex '.*\.(cpp|cc|c\+\+|cxx|cl|h|hh|hpp|m|mm|inc)' \
        > clang-tidy-result/fixes.yml
        cat clang-tidy-result/fixes.yml |\
        sed -e 's/\x1b\[[0-9;]*m//g' |\
        sed 's/\(^.*\):\([0-9]*\):\([0-9]*\): warning:/::warning file=\1,line=\2,col=\3::/' |\
        sed 's/\(^.*\):\([0-9]*\):\([0-9]*\): error:/::error file=\1,line=\2,col=\3::/'
        echo "WARN_NUM=$(sed -e 's/\x1b\[[0-9;]*m//g'  clang-tidy-result/fixes.yml | grep -w " warning:" | wc -l | xargs)" >> $GITHUB_ENV
        echo "ERROR_NUM=$(sed -e 's/\x1b\[[0-9;]*m//g'  clang-tidy-result/fixes.yml | grep -w " error:" | wc -l | xargs)" >> $GITHUB_ENV

    - name: clang-tidy results
      run: |
          if [ "${{ env.WARN_NUM }}" -eq "0" ] && [ "${{ env.ERROR_NUM }}" -eq "0" ]; then
            echo "::notice::All clean, LGTM!"
          else
            cat clang-tidy-result/fixes.yml | sed -e 's/\x1b\[[0-9;]*mnote: \x1b\[0m/\x1b\[33mnote: \x1b\[0m/g'
            echo "::notice::Clang-tidy generates ${{ env.WARN_NUM }} warnings and ${{ env.ERROR_NUM }} errors! Please fix them before being merged."
            exit 1
          fi
      shell: bash

